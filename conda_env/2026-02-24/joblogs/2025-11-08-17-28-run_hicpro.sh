#!/bin/bash

# =============================================================================
# Hi-C 小试数据质量控制自动化脚本
# =============================================================================
#
# 功能:
# 1. 设置分析目录结构。
# 2. 准备参考基因组 (Bowtie2索引, 酶切片段文件)。
# 3. 自动生成 HiC-Pro 配置文件。
# 4. 运行 HiC-Pro。
# 5. 解析关键QC结果，生成一份易于理解的总结报告。
#
# 使用方法:
# 1. 将此脚本保存为 run_hic_qc.sh。
# 2. 修改下面的 "用户配置" 部分，确保所有路径和参数正确。
# 3. 赋予执行权限: chmod +x run_hic_qc.sh
# 4. 运行脚本: ./run_hic_qc.sh
#
# =============================================================================

set -e # 若有任何命令执行失败，则立即退出脚本
set -o pipefail # 管道中任何一个命令失败，都视为整个管道失败

# --- 将HiC-Pro的utils工具路径添加到环境变量 ---
HICPRO_UTILS_PATH="/share/org/YZWL/yzwl_lixg/software/HiC-Pro_3.1.0/bin"
export PATH=$HICPRO_UTILS_PATH:$PATH

# --- (1) 用户配置: 请根据您的实际情况修改以下变量 ---

# --- 路径设置 ---
# 拟南芥基因组fasta文件绝对路径
GENOME_FA="/share/org/YZWL/yzwl_lixg/project/22.拟南芥hic/02.小试/hicpro/genome.fa"
# Hi-C小试数据的原始fq.gz文件所在目录 (RawData目录)
RAW_DATA_DIR="/share/org/YZWL/yzwl_lixg/project/22.拟南芥hic/02.小试/hicpro/hic_fstq"
# 分析工作主目录 (脚本将在此目录下创建所有文件)
ANALYSIS_DIR="/share/org/YZWL/yzwl_lixg/project/22.拟南芥hic/02.小试/hicpro"

# --- Hi-C 实验参数 ---
# 请与测序公司确认建库所用的限制性内切酶，MboI是最常见的
ENZYME_NAME="MboI"
RE_SEQUENCE="^GATC"      # MboI 的识别序列
LIGATION_SITE="GATCGATC" # MboI 酶切连接后的序列

# --- 计算资源 ---
N_CPU=80  # 使用的CPU线程数

# --- 用户配置结束 ---


# =============================================================================
# --- (2) 脚本主体部分 (通常无需修改) ---
# =============================================================================

# --- 创建目录结构 ---
echo "INFO: 正在于 ${ANALYSIS_DIR} 创建分析目录..."
mkdir -p "${ANALYSIS_DIR}/reference"
# mkdir -p "${ANALYSIS_DIR}/hic_results"
mkdir -p "${ANALYSIS_DIR}/tmp"
cd "${ANALYSIS_DIR}"

# --- 定义内部变量 ---
REF_DIR="${ANALYSIS_DIR}/reference"
HIC_RESULTS_DIR="${ANALYSIS_DIR}/hic_results"
TMP_DIR="${ANALYSIS_DIR}/tmp"
CONFIG_FILE="${ANALYSIS_DIR}/config-hicpro.txt"

# --- 转换为绝对路径以避免问题 ---
GENOME_FA=$(realpath "${GENOME_FA}")
RAW_DATA_DIR=$(realpath "${RAW_DATA_DIR}")

# --- (3) 准备参考基因组相关文件 ---
echo "INFO: --- 开始准备参考基因组文件 ---"

# --- 建立 Bowtie2 索引 ---
GENOME_PREFIX="${REF_DIR}/genome"
if [ -f "${GENOME_PREFIX}.1.bt2" ]; then
    echo "INFO: Bowtie2索引已存在, 跳过构建步骤。"
else
    echo "INFO: 正在构建Bowtie2索引..."
    bowtie2-build --threads "${N_CPU}" "${GENOME_FA}" "${GENOME_PREFIX}"
fi

# --- 生成染色体大小文件 ---
CHROM_SIZES="${REF_DIR}/genome.chrom.sizes"
if [ -f "${CHROM_SIZES}" ]; then
    echo "INFO: 染色体大小文件已存在, 跳过生成步骤。"
else
    echo "INFO: 正在生成染色体大小文件..."
    # 确保fasta索引存在
    if [ ! -f "${GENOME_FA}.fai" ]; then
        samtools faidx "${GENOME_FA}"
    fi
    awk -v OFS='\t' '{print $1, $2}' "${GENOME_FA}.fai" > "${CHROM_SIZES}"
fi

# --- 生成基因组酶切片段文件 ---
GENOME_FRAGMENTS="${REF_DIR}/genome_${ENZYME_NAME}.bed"
if [ -f "${GENOME_FRAGMENTS}" ]; then
    echo "INFO: 基因组酶切片段文件已存在, 跳过生成步骤。"
else
    echo "INFO: 正在使用 '${ENZYME_NAME}' 酶切基因组..."
    digest_genome.py -r "${RE_SEQUENCE}" -o "${GENOME_FRAGMENTS}" "${GENOME_FA}"
fi

echo "INFO: --- 参考基因组文件准备完毕 ---"


# --- (4) 动态生成 HiC-Pro 配置文件 ---
echo "INFO: 正在生成HiC-Pro配置文件: ${CONFIG_FILE}"

cat << EOF > "${CONFIG_FILE}"
# Hi-C Pro configuration file generated by script

N_CPU = ${N_CPU}
LOG_FILE = ${ANALYSIS_DIR}/hicpro.log
TMP_DIR = ${TMP_DIR}

PAIR1_EXT = _1.fq.gz
PAIR2_EXT = _2.fq.gz
BOWTIE2_IDX_PATH = ${REF_DIR}
REFERENCE_GENOME = ${GENOME_FA}
GENOME_SIZE = ${CHROM_SIZES}
GENOME_FRAGMENT = ${GENOME_FRAGMENTS}
LIGATION_SITE = ${LIGATION_SITE}
MIN_MAPQ = 10

GET_ALL_INTERACTION_CLASSES = 1
GET_PROCESS_SUMMARY = 1

BIN_SIZE = 100000 50000
ICE_MAX_ITER = 100
EOF

echo "INFO: 配置文件创建成功。"


# --- (5) 运行 HiC-Pro ---
echo "INFO: --- 开始运行 HiC-Pro 分析流程 ---"
echo "INFO: 原始数据目录: ${RAW_DATA_DIR}"
echo "INFO: 结果输出目录: ${HIC_RESULTS_DIR}"

HiC-Pro -i "${RAW_DATA_DIR}" \
        -o "${HIC_RESULTS_DIR}" \
        -c "${CONFIG_FILE}"

echo "INFO: --- HiC-Pro 分析流程结束 ---"


# --- (6) 解析结果并生成最终QC报告 ---
echo "INFO: --- 正在生成QC总结报告 ---"

# 找到统计文件
MAP_STATS_FILE=$(find "${HIC_RESULTS_DIR}/hic_logs/" -name "*.mstat" | head -n 1)
BOWTIE_SUMMARY_FILE="${HIC_RESULTS_DIR}/bowtie_results/bwt2_global_summary.txt"

if [ ! -f "${MAP_STATS_FILE}" ] || [ ! -f "${BOWTIE_SUMMARY_FILE}" ]; then
    echo "错误: 关键统计文件未找到, HiC-Pro可能运行失败。"
    exit 1
fi

# 解析Bowtie2比对总结
TOTAL_READS_BWT2=$(grep "Total pairs" "${BOWTIE_SUMMARY_FILE}" | awk '{print $4}')
MAPPED_PERCENT=$(grep "Overall alignment rate" "${BOWTIE_SUMMARY_FILE}" | awk '{print $1}' | tr -d '%')

# 解析HiC-Pro流程统计
TOTAL_PAIRS_PROC=$(grep "total_pairs_processed" "${MAP_STATS_FILE}" | awk '{print $2}')
VALID_INTERACTIONS=$(grep "valid_interaction" "${MAP_STATS_FILE}" | awk '{print $2}')
VALID_INTERACTIONS_NODUPS=$(grep "valid_interaction_rmdup" "${MAP_STATS_FILE}" | awk '{print $2}')
CIS_INTERACTIONS=$(grep "cis_interaction" "${MAP_STATS_FILE}" | awk '{print $2}')
TRANS_INTERACTIONS=$(grep "trans_interaction" "${MAP_STATS_FILE}" | awk '{print $2}')
CIS_SHORT=$(grep "cis_shortRange" "${MAP_STATS_FILE}" | awk '{print $2}')
CIS_LONG=$(grep "cis_longRange" "${MAP_STATS_FILE}" | awk '{print $2}')

# 计算各项比率
VALID_PERCENT=$(awk "BEGIN {if ($TOTAL_PAIRS_PROC>0) printf \"%.2f\", $VALID_INTERACTIONS*100/$TOTAL_PAIRS_PROC; else print 0}")
DUPLICATION_PERCENT=$(awk "BEGIN {if ($VALID_INTERACTIONS>0) printf \"%.2f\", (1 - $VALID_INTERACTIONS_NODUPS/$VALID_INTERACTIONS)*100; else print 0}")
TOTAL_CIS_TRANS=$(awk "BEGIN {print $CIS_INTERACTIONS+$TRANS_INTERACTIONS}")
CIS_PERCENT=$(awk "BEGIN {if ($TOTAL_CIS_TRANS>0) printf \"%.2f\", $CIS_INTERACTIONS*100/$TOTAL_CIS_TRANS; else print 0}")
TOTAL_CIS=$(awk "BEGIN {print $CIS_SHORT+$CIS_LONG}")
CIS_LONG_PERCENT=$(awk "BEGIN {if ($TOTAL_CIS>0) printf \"%.2f\", $CIS_LONG*100/$TOTAL_CIS; else print 0}")

# 定义评估函数
get_eval() {
    value=$(echo "$1" | awk '{print int($1)}') # 转为整数比较
    good_thr=$2
    ok_thr=$3
    if (( value >= good_thr )); then
        echo "优秀 (EXCELLENT)"
    elif (( value >= ok_thr )); then
        echo "可接受 (ACCEPTABLE)"
    else
        echo "较差 (POOR) - 需重点关注"
    fi
}

MAPPED_EVAL=$(get_eval "$MAPPED_PERCENT" 90 80)
VALID_EVAL=$(get_eval "$VALID_PERCENT" 20 10)
CIS_EVAL=$(get_eval "$CIS_PERCENT" 80 60)
CIS_LONG_EVAL=$(get_eval "$CIS_LONG_PERCENT" 40 20)

# --- 将报告打印到屏幕并保存到文件 ---
REPORT_FILE="${ANALYSIS_DIR}/QC_SUMMARY_REPORT.txt"
{
    echo "================================================================"
    echo "             Hi-C 小试数据质量控制 (QC) 总结报告                "
    echo "================================================================"
    echo "报告生成时间: $(date)"
    echo "原始数据目录: ${RAW_DATA_DIR}"
    echo "----------------------------------------------------------------"
    echo ""
    echo "[1] 比对统计 (Mapping Statistics)"
    echo "    - 总 Reads 对数:      ${TOTAL_READS_BWT2}"
    echo "    - 整体比对率:         ${MAPPED_PERCENT}%  [评估: ${MAPPED_EVAL}]"
    echo "      (评估标准: >80% 可接受, >90% 优秀)"
    echo ""
    echo "[2] 有效交互统计 (Valid Interaction Statistics)"
    echo "    - 进入Hi-C分析流程的总 Reads 对数: ${TOTAL_PAIRS_PROC}"
    echo "    - 去重后最终有效交互对 (Valid Pairs): ${VALID_INTERACTIONS_NODUPS}"
    echo "    - 有效交互率 (Valid Interaction Rate): ${VALID_PERCENT}%  [评估: ${VALID_EVAL}]"
    echo "      (【核心指标】评估标准: >10% 可接受, >20% 优秀)"
    echo ""
    echo "[3] 文库质量评估 (Library Quality Metrics)"
    echo "    - PCR 重复率 (Duplication Rate):    ${DUPLICATION_PERCENT}%"
    echo "      (此值越低越好，代表文库复杂度越高)"
    echo ""
    echo "    - Cis 交互占比 (顺式，同一染色体内部): ${CIS_PERCENT}%  [评估: ${CIS_EVAL}]"
    echo "      (Cis应占主导。评估标准: >60% 可接受, >80% 优秀)"
    echo ""
    echo "    - Cis 长程交互占比 (Cis > 20kb): ${CIS_LONG_PERCENT}%  [评估: ${CIS_LONG_EVAL}]"
    echo "      (此值越高，捕获远距离互作能力越强。评估标准: >20% 可接受, >40% 优秀)"
    echo ""
    echo "----------------------------------------------------------------"
    echo "最终决策建议:"
    if (( $(echo "$VALID_PERCENT >= 10" | bc -l) )) && (( $(echo "$CIS_PERCENT >= 60" | bc -l) )); then
        echo "  [建议: GO] 数据质量“可接受”或“优秀”。"
        echo "  核心指标达到了进行大规模测序的最低要求，可以安排后续测序。"
    elif (( $(echo "$VALID_PERCENT >= 5" | bc -l) )); then
        echo "  [建议: DISCUSS] 数据质量处于“临界状态”。"
        echo "  有效交互率较低 (5-10%)。建议与测序公司讨论实验细节，谨慎评估是否继续。"
    else
        echo "  [建议: NO-GO] 数据质量“较差”。"
        echo "  有效交互率极低 (<5%)，【不建议】进行大规模测序。"
        echo "  强烈建议检查文库构建环节是否存在问题。"
    fi
    echo "================================================================"
    echo "完整的 HiC-Pro 结果位于: ${HIC_RESULTS_DIR}"
    echo "详细的 HTML 交互式报告位于: ${HIC_RESULTS_DIR}/hic_pro_report.html"

} | tee "${REPORT_FILE}"

echo "INFO: QC总结报告已保存至 ${REPORT_FILE}"
echo "INFO: 流程运行完毕。"