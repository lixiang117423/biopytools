#!/usr/bin/env zsh
# =============================================================================
#  ~/.zshrc - Zsh Configuration
#  é‡æ„ä¼˜åŒ–ç‰ˆæœ¬ - ç®€æ´æ¸…æ™°çš„æ¨¡å—åŒ–é…ç½®
# =============================================================================

# -----------------------------------------------------------------------------
#  [1] æ€§èƒ½ä¼˜åŒ–ï¼šå¿«é€Ÿæ£€æŸ¥å’Œæ—©æœŸé€€å‡º
# -----------------------------------------------------------------------------

# éäº¤äº’å¼shellå¿«é€Ÿé€€å‡º
[[ $- != *i* ]] && return

# æ£€æŸ¥zshç‰ˆæœ¬å…¼å®¹æ€§
autoload -U is-at-least
is-at-least 5.1 || {
    echo "è­¦å‘Š: éœ€è¦ Zsh 5.1 æˆ–æ›´é«˜ç‰ˆæœ¬" >&2
    return 1
}

# -----------------------------------------------------------------------------
#  [2] ç¯å¢ƒå˜é‡è®¾ç½®
# -----------------------------------------------------------------------------

# ç¼–è¾‘å™¨
export EDITOR='vim'
export VISUAL='vim'

# è¯­è¨€ç¯å¢ƒ
export LANG='zh_CN.UTF-8'
export LC_ALL='zh_CN.UTF-8'

# PATH
export PATH="$HOME/.local/bin:$PATH"

# XDGè§„èŒƒç›®å½•
export XDG_CONFIG_HOME="${XDG_CONFIG_HOME:-$HOME/.config}"
export XDG_CACHE_HOME="${XDG_CACHE_HOME:-$HOME/.cache}"
export XDG_DATA_HOME="${XDG_DATA_HOME:-$HOME/.local/share}"

# -----------------------------------------------------------------------------
#  [3] Zsh æ ¸å¿ƒé€‰é¡¹é…ç½®
# -----------------------------------------------------------------------------

# === 3.1 å†å²è®°å½• ===
export HISTSIZE=100000
export SAVEHIST=100000
export HISTFILE="${XDG_DATA_HOME}/zsh/history"

# åˆ›å»ºå†å²æ–‡ä»¶ç›®å½•
[[ -d "${HISTFILE:h}" ]] || mkdir -p "${HISTFILE:h}"

setopt INC_APPEND_HISTORY
setopt EXTENDED_HISTORY        # è®°å½•æ—¶é—´æˆ³
setopt SHARE_HISTORY          # å®æ—¶å…±äº«å†å²
setopt HIST_EXPIRE_DUPS_FIRST # ä¼˜å…ˆåˆ é™¤é‡å¤è®°å½•
setopt HIST_IGNORE_DUPS       # å¿½ç•¥è¿ç»­é‡å¤
setopt HIST_IGNORE_SPACE      # å¿½ç•¥ç©ºæ ¼å¼€å¤´çš„å‘½ä»¤
setopt HIST_REDUCE_BLANKS     # åˆ é™¤å¤šä½™ç©ºæ ¼
setopt HIST_VERIFY            # å†å²å±•å¼€ç¡®è®¤

# === 3.2 ç›®å½•å¯¼èˆª ===
setopt AUTO_CD               # è¾“å…¥ç›®å½•åè‡ªåŠ¨cd
setopt AUTO_PUSHD            # è‡ªåŠ¨æ¨é€åˆ°ç›®å½•æ ˆ
setopt PUSHD_IGNORE_DUPS     # å¿½ç•¥é‡å¤ç›®å½•
setopt PUSHD_SILENT          # é™é»˜pushd

# === 3.3 å…¨å±€åŒ¹é… ===
setopt EXTENDED_GLOB         # æ‰©å±•globæ¨¡å¼
setopt GLOB_DOTS             # åŒ¹é…éšè—æ–‡ä»¶
setopt NULL_GLOB             # æ— åŒ¹é…æ—¶è¿”å›ç©º

# === 3.4 å…¶ä»–é€‰é¡¹ ===
setopt INTERACTIVE_COMMENTS  # å…è®¸äº¤äº’å¼æ³¨é‡Š
setopt NO_BEEP              # ç¦ç”¨æç¤ºéŸ³
setopt CORRECT              # å‘½ä»¤è‡ªåŠ¨çº é”™
setopt COMPLETE_IN_WORD     # å•è¯ä¸­è¡¥å…¨
setopt ALWAYS_TO_END        # è¡¥å…¨æ—¶å…‰æ ‡ç§»åˆ°æœ«å°¾

# -----------------------------------------------------------------------------
#  [4] è‡ªåŠ¨è¡¥å…¨ç³»ç»Ÿ
# -----------------------------------------------------------------------------

# åˆ›å»ºè¡¥å…¨ç¼“å­˜ç›®å½•
ZSH_CACHE_DIR="${XDG_CACHE_HOME}/zsh"
[[ -d "$ZSH_CACHE_DIR" ]] || mkdir -p "$ZSH_CACHE_DIR"

# æ™ºèƒ½åˆå§‹åŒ–è¡¥å…¨ç³»ç»Ÿ
autoload -Uz compinit
typeset -i updated_at=$(date +'%j' -r ~/.zcompdump 2>/dev/null || stat -f '%Sm' -t '%j' ~/.zcompdump 2>/dev/null || echo 0)
if [ $updated_at != $(date +'%j') ]; then
    compinit -d "$ZSH_CACHE_DIR/zcompdump"
else
    compinit -C -d "$ZSH_CACHE_DIR/zcompdump"
fi

# è¡¥å…¨æ ·å¼é…ç½®
zstyle ':completion:*' menu select
zstyle ':completion:*' list-colors "${(s.:.)LS_COLORS}"
zstyle ':completion:*' matcher-list 'm:{a-zA-Z}={A-Za-z}' 'r:|[._-]=* r:|=*' 'l:|=* r:|=*'
zstyle ':completion:*' use-cache yes
zstyle ':completion:*' cache-path "$ZSH_CACHE_DIR/completions"
zstyle ':completion:*' rehash true
zstyle ':completion:*' complete-options true
zstyle ':completion:*' format ' %F{yellow}-- %d --%f'
zstyle ':completion:*' group-name ''
zstyle ':completion:*' verbose yes

# è¿›ç¨‹è¡¥å…¨ä¼˜åŒ–
zstyle ':completion:*:*:*:*:processes' force-list always
zstyle ':completion:*:*:kill:*:processes' list-colors '=(#b) #([0-9]#) ([0-9a-z-]#)*=01;34=0=01'

# -----------------------------------------------------------------------------
#  [5] é”®ç»‘å®š
# -----------------------------------------------------------------------------

# Emacsæ¨¡å¼é”®ç»‘å®š
bindkey -e

# æ™ºèƒ½å†å²æœç´¢ï¼ˆå¦‚æœæ’ä»¶å¯ç”¨ï¼‰
autoload -U history-search-end
zle -N history-beginning-search-backward-end history-search-end
zle -N history-beginning-search-forward-end history-search-end
bindkey "^P" history-beginning-search-backward-end
bindkey "^N" history-beginning-search-forward-end

# å¸¸ç”¨å¿«æ·é”®
bindkey "^A" beginning-of-line
bindkey "^E" end-of-line
bindkey "^K" kill-line
bindkey "^U" kill-whole-line
bindkey "^W" backward-kill-word
bindkey "^R" history-incremental-search-backward

# -----------------------------------------------------------------------------
#  [6] æ’ä»¶ç³»ç»Ÿ
# -----------------------------------------------------------------------------

# æ’ä»¶åŸºç¡€è·¯å¾„
# readonly ZSH_CUSTOM="${ZSH_CUSTOM:-$HOME/.oh-my-zsh/custom}"
# readonly PLUGIN_DIR="$ZSH_CUSTOM/plugins"
# æ’ä»¶åŸºç¡€è·¯å¾„
if [[ -z "$ZSH_CUSTOM" ]]; then
  readonly ZSH_CUSTOM="$HOME/.oh-my-zsh/custom"
fi

if [[ -z "$PLUGIN_DIR" ]]; then
  readonly PLUGIN_DIR="$ZSH_CUSTOM/plugins"
fi

# æ’ä»¶åŠ è½½å‡½æ•°
load_plugin() {
    local plugin_name="$1"
    local plugin_path="$PLUGIN_DIR/$plugin_name"
    local plugin_file="$plugin_path/$plugin_name.zsh"
    
    if [[ -f "$plugin_file" ]]; then
        source "$plugin_file"
        return 0
    else
        echo "æ’ä»¶ $plugin_name æœªæ‰¾åˆ°: $plugin_file" >&2
        return 1
    fi
}

# æ ¸å¿ƒæ’ä»¶åŠ è½½
if [[ -d "$PLUGIN_DIR" ]]; then
    # è‡ªåŠ¨å»ºè®®æ’ä»¶
    if load_plugin "zsh-autosuggestions"; then
        ZSH_AUTOSUGGEST_HIGHLIGHT_STYLE="fg=#666666,underline"
        ZSH_AUTOSUGGEST_STRATEGY=(history completion)
        ZSH_AUTOSUGGEST_BUFFER_MAX_SIZE=20
    fi
    
    # å†å²å­ä¸²æœç´¢
    if load_plugin "zsh-history-substring-search"; then
        bindkey '^[[A' history-substring-search-up
        bindkey '^[[B' history-substring-search-down
        HISTORY_SUBSTRING_SEARCH_HIGHLIGHT_FOUND='bg=yellow,fg=black,bold'
        HISTORY_SUBSTRING_SEARCH_HIGHLIGHT_NOT_FOUND='bg=red,fg=white,bold'
    fi
    
    # è¯­æ³•é«˜äº®ï¼ˆå¿…é¡»æœ€ååŠ è½½ï¼‰
    load_plugin "zsh-syntax-highlighting"
fi

# -----------------------------------------------------------------------------
#  [7] å¤–éƒ¨å·¥å…·åˆå§‹åŒ–
# -----------------------------------------------------------------------------

# === 7.1 Conda/Mamba åˆå§‹åŒ– ===
init_conda() {
    local conda_base="/share/org/YZWL/yzwl_lixg/miniforge3"
    local conda_exe="$conda_base/bin/conda"
    local mamba_exe="$conda_base/bin/mamba"
    
    if [[ -x "$conda_exe" ]]; then
        # Condaåˆå§‹åŒ–
        local conda_setup="$("$conda_exe" 'shell.zsh' 'hook' 2>/dev/null)"
        if [[ $? -eq 0 ]]; then
            eval "$conda_setup"
        elif [[ -f "$conda_base/etc/profile.d/conda.sh" ]]; then
            source "$conda_base/etc/profile.d/conda.sh"
        else
            export PATH="$conda_base/bin:$PATH"
        fi
        
        # Mambaåˆå§‹åŒ–
        if [[ -x "$mamba_exe" ]]; then
            export MAMBA_EXE="$mamba_exe"
            export MAMBA_ROOT_PREFIX="$conda_base"
            local mamba_setup="$("$mamba_exe" shell hook --shell zsh --root-prefix "$conda_base" 2>/dev/null)"
            if [[ $? -eq 0 ]]; then
                eval "$mamba_setup"
            else
                alias mamba="$mamba_exe"
            fi
        fi
    fi
}

# å¼‚æ­¥åˆå§‹åŒ–condaï¼ˆå¯é€‰ï¼‰
if [[ -n "$ZSH_VERSION" ]]; then
    init_conda
fi

# === 7.2 Starship æç¤ºç¬¦ ===
if command -v starship >/dev/null 2>&1; then
    eval "$(starship init zsh)"
else
    # ç®€æ´çš„å¤‡ç”¨æç¤ºç¬¦
    autoload -U colors && colors
    PS1='%{$fg[cyan]%}%n@%m%{$reset_color%}:%{$fg[yellow]%}%~%{$reset_color%}%# '
fi

# === 7.3 å…¶ä»–å·¥å…·é›†æˆ ===
# Tabby Terminal é›†æˆ
if [[ "$TERM_PROGRAM" == "Tabby" ]]; then
    precmd() {
        echo -n "\x1b]1337;CurrentDir=$(pwd)\x07"
    }
fi

# -----------------------------------------------------------------------------
#  [8] å‡½æ•°å®šä¹‰åŒºåŸŸ
# -----------------------------------------------------------------------------

# === 8.1 é…ç½®ç®¡ç†å‡½æ•° ===
reload() {
    echo "ğŸ”„ é‡æ–°åŠ è½½zshé…ç½®..."
    source ~/.zshrc
    echo "âœ… é…ç½®é‡æ–°åŠ è½½å®Œæˆ"
    command -v welcome >/dev/null 2>&1 && welcome
}

# === 8.2 å‡½æ•°å¸®åŠ©ç³»ç»Ÿ ===
fun() {
    local usage="ç”¨æ³•: fun [é€‰é¡¹] [ç±»åˆ«]
é€‰é¡¹:
  -s, --search TERM    æœç´¢åŒ…å«æŒ‡å®šè¯æ±‡çš„å‡½æ•°
  -h, --help          æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯

ç±»åˆ«:
  file     æ–‡ä»¶æ“ä½œå‡½æ•°
  data     æ•°æ®å¤„ç†å‡½æ•°  
  system   ç³»ç»Ÿå·¥å…·å‡½æ•°
  backup   å¤‡ä»½ç®¡ç†å‡½æ•°
  bio      ç”Ÿç‰©ä¿¡æ¯å­¦å‡½æ•°
  dev      å¼€å‘å·¥å…·å‡½æ•°
  net      ç½‘ç»œå·¥å…·å‡½æ•°"

    # å‚æ•°è§£æ
    local search_mode=false
    local search_term=""
    local category=""
    
    while [[ $# -gt 0 ]]; do
        case $1 in
            -h|--help)
                echo "$usage"
                return 0
                ;;
            -s|--search)
                if [[ -z "$2" ]]; then
                    echo "é”™è¯¯: --search éœ€è¦æä¾›æœç´¢è¯" >&2
                    return 1
                fi
                search_mode=true
                search_term="$2"
                shift 2
                ;;
            file|data|system|backup|bio|dev|net)
                category="$1"
                shift
                ;;
            *)
                echo "é”™è¯¯: æœªçŸ¥å‚æ•° '$1'" >&2
                echo "$usage"
                return 1
                ;;
        esac
    done
    
    # å‡½æ•°åˆ—è¡¨ï¼ˆåˆ†ç¦»åˆ°å¤–éƒ¨æ–‡ä»¶ä¼šæ›´å¥½ï¼‰
    local functions=(
        "file:x:æ™ºèƒ½è§£å‹ç¼©:x archive.tar.gz"
        "file:uz:è§£å‹åˆ°æŒ‡å®šç›®å½•:uz archive.zip /target/dir"  
        "file:mkcd:åˆ›å»ºå¹¶è¿›å…¥ç›®å½•:mkcd new_project"
        "data:csv_head:æ˜¾ç¤ºCSVå¤´éƒ¨:csv_head data.csv 10"
        "data:csv_stats:CSVç»Ÿè®¡ä¿¡æ¯:csv_stats data.csv"
        "system:sysinfo:ç³»ç»Ÿä¿¡æ¯:sysinfo"
        "system:myip:æ˜¾ç¤ºIPåœ°å€:myip"
        "backup:backup_home:å¤‡ä»½ç”¨æˆ·ç›®å½•:backup_home"
        "bio:index_genome:æ„å»ºåŸºå› ç»„ç´¢å¼•:index_genome genome.fa"
        "dev:serve:æœ¬åœ°HTTPæœåŠ¡:serve 8080"
        "net:port:ç«¯å£æ£€æŸ¥:port 22"
    )
    
    _display_functions() {
        local cat="$1"
        local cat_display="$2"
        local found=false
        
        for func_info in "${functions[@]}"; do
            local func_cat="${func_info%%:*}"
            if [[ "$func_cat" == "$cat" ]]; then
                if [[ "$found" == false ]]; then
                    echo -e "\n$cat_display"
                    echo "$(printf '%.0sâ”€' {1..40})"
                    found=true
                fi
                
                local remaining="${func_info#*:}"
                local func_name="${remaining%%:*}"
                remaining="${remaining#*:}"
                local func_desc="${remaining%%:*}"
                local func_usage="${remaining#*:}"
                
                printf "  %-15s %s\n" "$func_name" "$func_desc"
                printf "  %-15s ç¤ºä¾‹: %s\n" "" "$func_usage"
            fi
        done
    }
    
    # æœç´¢æ¨¡å¼
    if [[ "$search_mode" == true ]]; then
        echo "ğŸ” æœç´¢ç»“æœ: '$search_term'"
        local found_count=0
        for func_info in "${functions[@]}"; do
            if [[ "$func_info" == *"$search_term"* ]]; then
                ((found_count++))
                local remaining="${func_info#*:}"
                local func_name="${remaining%%:*}"
                remaining="${remaining#*:}"
                local func_desc="${remaining%%:*}"
                local func_usage="${remaining#*:}"
                
                printf "  %-15s %s\n" "$func_name" "$func_desc"
                printf "  %-15s ç¤ºä¾‹: %s\n" "" "$func_usage"
            fi
        done
        [[ $found_count -eq 0 ]] && echo "  æœªæ‰¾åˆ°åŒ¹é…çš„å‡½æ•°"
        return 0
    fi
    
    # æ˜¾ç¤ºå‡½æ•°åˆ—è¡¨
    echo "ğŸ“š è‡ªå®šä¹‰å‡½æ•°åˆ—è¡¨"
    
    if [[ -n "$category" ]]; then
        case "$category" in
            file) _display_functions "file" "ğŸ“ æ–‡ä»¶æ“ä½œ" ;;
            data) _display_functions "data" "ğŸ“Š æ•°æ®å¤„ç†" ;;
            system) _display_functions "system" "ğŸ”§ ç³»ç»Ÿå·¥å…·" ;;
            backup) _display_functions "backup" "ğŸ’¾ å¤‡ä»½ç®¡ç†" ;;
            bio) _display_functions "bio" "ğŸ§¬ ç”Ÿç‰©ä¿¡æ¯å­¦" ;;
            dev) _display_functions "dev" "ğŸ’» å¼€å‘å·¥å…·" ;;
            net) _display_functions "net" "ğŸŒ ç½‘ç»œå·¥å…·" ;;
        esac
    else
        _display_functions "file" "ğŸ“ æ–‡ä»¶æ“ä½œ"
        _display_functions "data" "ğŸ“Š æ•°æ®å¤„ç†"
        _display_functions "system" "ğŸ”§ ç³»ç»Ÿå·¥å…·"
        _display_functions "backup" "ğŸ’¾ å¤‡ä»½ç®¡ç†"
        _display_functions "bio" "ğŸ§¬ ç”Ÿç‰©ä¿¡æ¯å­¦"
        _display_functions "dev" "ğŸ’» å¼€å‘å·¥å…·"
        _display_functions "net" "ğŸŒ ç½‘ç»œå·¥å…·"
        
        echo -e "\nğŸ’¡ ä½¿ç”¨æç¤º:"
        echo "  fun file                    æ˜¾ç¤ºæ–‡ä»¶æ“ä½œå‡½æ•°"
        echo "  fun -s extract             æœç´¢ç›¸å…³å‡½æ•°"
        echo "  <å‡½æ•°å> -h                æŸ¥çœ‹å‡½æ•°å¸®åŠ©"
    fi
}

# åˆ«åè®¾ç½®
alias funcs=fun
alias functions=fun
alias f=fun

# -----------------------------------------------------------------------------
#  [9] å¤–éƒ¨å‡½æ•°åŠ è½½
# -----------------------------------------------------------------------------

# ä»å¤–éƒ¨ç›®å½•åŠ è½½å‡½æ•°
load_external_functions() {
    local func_dir="$HOME/zsh/functions"
    
    if [[ -d "$func_dir" ]]; then
        for func_file in "$func_dir"/*.zsh; do
            [[ -r "$func_file" ]] && source "$func_file"
        done
    else
        echo "æç¤º: å¯åˆ›å»º $func_dir ç›®å½•å­˜æ”¾è‡ªå®šä¹‰å‡½æ•°" >&2
    fi
}

load_external_functions

# -----------------------------------------------------------------------------
#  [10] è‡ªåŠ¨è¡¥å…¨æ‰©å±•
# -----------------------------------------------------------------------------

# æ–‡ä»¶ç±»å‹ç›¸å…³è¡¥å…¨
if [[ -n "$ZSH_VERSION" ]]; then
    local archive_pattern="*.(tar.gz|tgz|tar.bz2|tbz2|tar.xz|txz|tar.Z|tar|zip|rar|7z|gz|bz2|xz|Z|deb|rpm)"
    
    # ä¸ºè§£å‹å‡½æ•°æ·»åŠ æ–‡ä»¶ç±»å‹è¡¥å…¨
    for cmd in x uz extract; do
        compdef "_files -g \"$archive_pattern\"" "$cmd"
    done
    
    # funå‡½æ•°è¡¥å…¨
    _fun_completion() {
        _arguments \
            '(-s --search)'{-s,--search}'[æœç´¢å‡½æ•°]:search term:' \
            '(-h --help)'{-h,--help}'[æ˜¾ç¤ºå¸®åŠ©]' \
            '1:category:(file data system backup bio dev net)'
    }
    compdef _fun_completion fun funcs functions f
fi

# -----------------------------------------------------------------------------
#  [11] æœ¬åœ°é…ç½®åŠ è½½
# -----------------------------------------------------------------------------

# åŠ è½½æœ¬åœ°è‡ªå®šä¹‰é…ç½®
for local_config in "$HOME/.zshrc.local" "$HOME/.config/zsh/local.zsh"; do
    [[ -r "$local_config" ]] && source "$local_config"
done

# -----------------------------------------------------------------------------
#  [12] æ¸…ç†å’Œæ¬¢è¿ä¿¡æ¯
# -----------------------------------------------------------------------------

# æ¸…ç†ä¸´æ—¶å˜é‡
unset ZSH_CACHE_DIR updated_at

# æ¸…ç†å‡½æ•°
unfunction load_plugin init_conda load_external_functions 2>/dev/null

# # äº¤äº’å¼shellæ¬¢è¿ä¿¡æ¯
# if [[ -o interactive && -o login ]]; then
#     echo "ğŸ¯ Zsh é…ç½®åŠ è½½å®Œæˆ | è¾“å…¥ 'fun' æŸ¥çœ‹è‡ªå®šä¹‰å‡½æ•°"
# fi

# =============================================================================
#  é…ç½®æ–‡ä»¶ç»“æŸ
# =============================================================================
# NVM configuration
export NVM_DIR="$HOME/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
[ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"

test -e "${HOME}/.iterm2_shell_integration.zsh" && source "${HOME}/.iterm2_shell_integration.zsh"


# KMERIA environment
export KMERIA_HOME=/share/org/YZWL/yzwl_lixg/software/kmeria
export KMERIA_CONDA=/share/org/YZWL/yzwl_lixg/miniforge3/envs/kmeriaenv
export LD_LIBRARY_PATH=${KMERIA_HOME}/lib:${KMERIA_CONDA}/lib:$LD_LIBRARY_PATH
export PATH=${KMERIA_HOME}/bin:${KMERIA_HOME}/bimbamAsso:${KMERIA_HOME}/external_tools:$PATH
