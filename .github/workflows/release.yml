name: Release Management

on:
  # 仅在推送标签时触发 Release 创建
  push:
    tags:
      - 'v*.*.*'
  # 可选：在 main 分支推送时仅运行清理任务（不创建 Release）
  workflow_dispatch:
    inputs:
      cleanup_only:
        description: '仅执行清理任务（不创建 Release）'
        required: false
        type: boolean
        default: true

permissions:
  contents: write

jobs:
  # Job 1: 创建 Release（仅在打标签时执行）
  create-release:
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Detect release type
        id: release_type
        run: |
          VERSION="${{ steps.get_version.outputs.VERSION }}"
          if [[ "$VERSION" =~ (alpha|beta|rc|pre) ]]; then
            echo "type=prerelease" >> $GITHUB_OUTPUT
            echo "is_prerelease=true" >> $GITHUB_OUTPUT
          else
            echo "type=release" >> $GITHUB_OUTPUT
            echo "is_prerelease=false" >> $GITHUB_OUTPUT
          fi

      - name: Build project (示例：构建项目)
        run: |
          # 在这里添加你的构建步骤
          # 例如：pip install build && python -m build
          echo "Building project..."

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.get_version.outputs.VERSION }}
          name: Release ${{ steps.get_version.outputs.VERSION }}
          body: |
            ## Release ${{ steps.get_version.outputs.VERSION }}

            ### Changes
            <!-- 在这里添加 Release 说明 -->

            ### Installation
            \`pip install biopytools==${{ steps.get_version.outputs.VERSION }}\`
          prerelease: ${{ steps.release_type.outputs.is_prerelease }}
          generate_release_notes: true
          files: |
            # 在这里列出要上传的文件
            # dist/*
            # *.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Job 2: 自动清理旧 Release（始终执行）
  cleanup-releases:
    runs-on: ubuntu-latest
    needs: create-release
    if: always() && (github.event_name == 'push' || github.event.inputs.cleanup_only == 'true')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Run cleanup script
        run: |
          python .github/scripts/cleanup_releases.py
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          # 配置参数
          KEEP_RELEASES: 10           # 正式版本保留数量
          KEEP_PRERELEASES: 5         # 测试版本保留数量
          DELETE_AFTER_DAYS: 30       # 删除超过天数的 Release
          DRY_RUN: false              # 设为 true 仅测试不实际删除

      - name: Upload cleanup log
        uses: actions/upload-artifact@v4
        with:
          name: cleanup-log-${{ github.run_number }}
          path: cleanup_log.txt
          retention-days: 30

  # Job 3: 仅清理任务（手动触发时使用）
  cleanup-only:
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Run cleanup script
        run: |
          python .github/scripts/cleanup_releases.py
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          KEEP_RELEASES: 10
          KEEP_PRERELEASES: 5
          DELETE_AFTER_DAYS: 30
          DRY_RUN: false

      - name: Upload cleanup log
        uses: actions/upload-artifact@v4
        with:
          name: cleanup-log-manual-${{ github.run_number }}
          path: cleanup_log.txt
          retention-days: 90
